name: '[Subflow] Deploy'
on:
  workflow_call:
    inputs:
      ENV:
        required: true
        type: string
      PACKAGE_ID:
        required: true
        type: string
      TAG:
        required: true
        type: string
      POST_TO_SLACK:
        type: boolean
    outputs:
      successfullyInstalled:
        description: 'Successful install'
        value: ${{ jobs.deploy.outputs.successfullyInstalled }}
      installOutput:
        description: 'Install output log'
        value: ${{ jobs.deploy.outputs.installOutput }}
jobs:
  # -------------------------------------------------------------------------- #
  #                                    Slack                                   #
  # -------------------------------------------------------------------------- #

  slack-prep:
    name: prep
    if: vars.SF_SLACK_ENABLED == 'true' && inputs.POST_TO_SLACK == true
    permissions:
      contents: read
      id-token: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: MariachiBear/get-repo-name-action@v1.2.0
        id: repo-name

      - name: Get SF url
        uses: thaitype/actions-switch-case@v1
        id: sf-url
        with:
          default: ${{ vars.SF_PROD_INSTANCE_URL }}
          conditionals-with-values: |
            ${{ inputs.ENV == 'preprod' }} => ${{ vars.SF_PREPROD_INSTANCE_URL }}
            ${{ inputs.ENV == 'sit' }} => ${{ vars.SF_SIT_INSTANCE_URL }}

      # Use https://app.slack.com/block-kit-builder to build messages.
      - name: Fetch Payload
        id: slack-data
        run: |
          echo 'blocks=[{"type":"header","text":{"type":"plain_text","text":"[${{ steps.repo-name.outputs.repository-name }}] Deployment → ${{ inputs.ENV }}","emoji":true}},{"type":"section","fields":[{"type":"mrkdwn","text":"*Version*\n${{ inputs.TAG }}"},{"type":"mrkdwn","text":"*Started By*\n<https://github.com/${{ github.actor }}|${{ github.actor }}>"}],"accessory":{"type":"overflow","options":[{"text":{"type":"plain_text","text":"👀 View Changelog"},"url":"https://github.com/${{ github.repository }}/releases/tag/${{ inputs.TAG }}"},{"text":{"type":"plain_text","text":"🤓 View Logs"},"url":"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"},{"text":{"type":"plain_text","text":"🤖 Open Repo"},"url":"https://github.com/${{ github.repository }}"},{"text":{"type":"plain_text","text":"☁️ Open ${{ inputs.ENV }}"},"url":"${{ steps.sf-url.outputs.match }}"}]}}]' >> $GITHUB_OUTPUT
          echo "text=Deployment ${{ steps.repo-name.outputs.repository-name }} → ${{ inputs.ENV }}" >> $GITHUB_OUTPUT
    outputs:
      blocks: ${{ steps.slack-data.outputs.blocks }}
      text: ${{ steps.slack-data.outputs.text }}
  slack-message:
    name: Slack
    needs: slack-prep
    if: vars.SF_SLACK_ENABLED == 'true' && inputs.POST_TO_SLACK == true
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/subflow.slack.yml
    secrets: inherit
    with:
      env: ${{ inputs.ENV }}
      job_name: slack post
      post-to-deployment-channel: true
      blocks: ${{ needs.slack-prep.outputs.blocks }}
      text: ${{ needs.slack-prep.outputs.text }}
      attachment_type: in_progress

  # -------------------------------------------------------------------------- #
  #                                   Deploy                                   #
  # -------------------------------------------------------------------------- #

  deploy:
    name: deploy
    permissions:
      contents: read
      id-token: write
    environment:
      name: ${{ inputs.ENV }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Install & Authorize sf cli
      - name: Install & Authorize sf cli (${{ inputs.ENV }})
        uses: sopra-steria-salesforce/sf-cli-setup@v0.8
        with:
          sf-cli-version: 2.34.7
          username: ${{ vars.SF_PREPROD_USERNAME }}
          client-id: ${{ secrets.SF_PREPROD_CLIENT_ID }}
          private-key: ${{ secrets.SF_PREPROD_PRIVATE_KEY }}
          set-default-org: true

      # TODO: Deploy Picklist
      # - name: Deploy Picklist Values
      #   run: deploy stuff

      # Install package in target org
      - name: Install package in target org
        id: deployment
        run: sf package:install --package ${{ inputs.PACKAGE_ID }} --installation-key ${{ secrets.SF_PACKAGE_KEY }} --wait 20 --publish-wait 20 --no-prompt --json | tee output

      # Check for Warnings
      - name: Check for Warnings
        run: |
          cat output | jq -c -r '.warnings[]' | while read -r warning; do
            echo "::warning::$warning"
          done

      # Check for Errors
      - name: Check for Errors
        id: check-error
        run: |
          if [ $(cat output | jq '.status') != "0" ]; then

            echo "::error::❌ PACKAGE INSTALLATION FAILED"
            echo "successfullyInstalled=false" >> $GITHUB_OUTPUT

            #* log to github action output
            cat output | jq -c -r '.result.Error | .[]?' | while read -r error; do
              echo "::error::$error"
            done
            cat output | jq -c -r '.message' | while read -r error; do
              if [ "$error" != "null" ]; then
                echo "::error::$error"
              fi
            done  

            #* output for slack
            errorOutput=$(cat output | jq -r '.message')
            errorOutput="${errorOutput//$'\n'/'\\n'}"
            echo -e "installOutput=$errorOutput" >> $GITHUB_OUTPUT
            
            #* cause an error in github, while saving the output
            exit 125
          fi
          echo "successfullyInstalled=true" >> $GITHUB_OUTPUT

      # Load .env file
      - name: Load .env file
        uses: xom9ikk/dotenv@v2.3.0
        with:
          path: ./env
          mode: ${{ inputs.ENV }}
          load-mode: skip

      # Deploy unpackagable content
      - name: Deploy unpackagable content
        run: |
          if [ -d "./force-app/unpackagable-with-auto-deploy" ]; then
            echo "Starting deployment of ./force-app/unpackagable-with-auto-deploy"
            sf project:deploy:start --ignore-conflicts --source-dir ./force-app/unpackagable-with-auto-deploy --test-level RunLocalTests
          fi

    outputs:
      successfullyInstalled: ${{ steps.check-error.outputs.successfullyInstalled }}
      installOutput: ${{ steps.check-error.outputs.installOutput }}

  # -------------------------------------------------------------------------- #
  #                                Update Slack                                #
  # -------------------------------------------------------------------------- #

  slack-update:
    name: slack status update
    needs: [slack-prep, slack-message, deploy]
    if: always() && inputs.POST_TO_SLACK == true
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/subflow.slack.yml
    secrets: inherit
    with:
      env: ${{ inputs.ENV }}
      job_name: slack status update
      post-to-deployment-channel: true
      update_ts: ${{ needs.slack-message.outputs.thread-ts }} # update this message
      blocks: ${{ needs.slack-prep.outputs.blocks }} # need the original blocks, otherwise it will be removed
      text: ${{ needs.slack-prep.outputs.text }} # need the original text, otherwise it will be removed
      attachment_type: ${{ needs.deploy.outputs.successfullyInstalled == 'true' && 'completed' || 'failed' }} # updates the original post with success or failure

  error-comment:
    name: post error message on failure
    needs: [slack-prep, slack-message, deploy]
    if: (always() && needs.deploy.outputs.successfullyInstalled == 'false' && inputs.POST_TO_SLACK == true) || failure()
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/subflow.slack.yml
    secrets: inherit
    with:
      env: ${{ inputs.ENV }}
      job_name: slack error comment
      post-to-deployment-channel: true
      thread_ts: ${{ needs.slack-message.outputs.thread-ts }} # reply to the update instead, in case the original message failed to post
      blocks: '[{"type":"section","text":{"type":"mrkdwn","text":"*Error Message*\n```${{ needs.deploy.outputs.installOutput }}```"}},{"type":"actions","elements":[{"type":"button","style":"danger","text":{"type":"plain_text","text":"🤓 View Logs","emoji":true},"url":"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}]}]'

  slack-notify-channel:
    name: notify on failure
    needs: [slack-prep, slack-message, deploy]
    if: (always() && needs.deploy.outputs.successfullyInstalled == 'false' && inputs.POST_TO_SLACK == true) || failure()
    permissions:
      contents: read
      id-token: write
    uses: ./.github/workflows/subflow.slack.yml
    secrets: inherit
    with:
      env: ${{ inputs.ENV }}
      job_name: 'slack @channel comment'
      post-to-deployment-channel: true
      thread_ts: ${{ needs.slack-message.outputs.thread-ts }} # reply to the update instead, in case the original message failed to post
      blocks: '[{"type":"section","text":{"type":"mrkdwn","text":"<!channel>, deployment failed 😢"}}]'
      reply_broadcast: true # post the reply to the channel
